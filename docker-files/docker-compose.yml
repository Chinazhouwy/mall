# 指定 Compose 文件的版本（推荐使用 3.8，兼容大部分 Docker 版本）
version: '3.8'

# 定义服务（每个服务对应一个容器）
services:
  # MySQL 服务（名称可自定义，这里用 mysql01 对应原有容器名）
  mysql01:
    # 镜像名称和版本
    image: mysql:5.7
    # 容器名称（和原有 --name 一致）
    container_name: mysql01
    # 端口映射（宿主机:容器内，对应原有 -p 3306:3306）
    ports:
      - "3306:3306"
    # 数据卷挂载（对应原有 -v 参数）
    volumes:
      - ../data/mydata/mysql/log:/var/log/mysql
      - ../data/mydata/mysql/data:/var/lib/mysql
      - ../data/mydata/mysql/conf/my.cnf:/etc/mysql/conf.d/my.cnf
    # 环境变量（对应原有 -e MYSQL_ROOT_PASSWORD=root）
    environment:
      # MySQL 根密码
      MYSQL_ROOT_PASSWORD: root
    # 重启策略：容器退出时自动重启（可选，增强稳定性）
    restart: always

  # Redis 服务（名称用 redis 对应原有容器名）
  redis:
    # 镜像名称（默认拉取最新版，对应原有 docker pull redis）
    image: redis
    # 容器名称
    container_name: redis
    # 端口映射（对应原有 -p 6379:6379）
    ports:
      - "6379:6379"
    # 数据卷挂载
    volumes:
      - ../data/mydata/redis/data:/data
      - ../data/mydata/redis/conf/redis.conf:/etc/redis/redis.conf
    # 容器启动命令（对应原有 redis-server /etc/redis/redis.conf）
    command: redis-server /etc/redis/redis.conf
    # 重启策略
    restart: always

  # 单机模式 + 外部 MySQL 数据库
  nacos:
    image: nacos/nacos-server:latest
    container_name: nacos
    environment:
      - PREFER_HOST_MODE=hostname
      - MODE=standalone
      - SPRING_DATASOURCE_PLATFORM=mysql
      - MYSQL_SERVICE_HOST=mysql01
      - MYSQL_SERVICE_DB_NAME=nacos_config
      - MYSQL_SERVICE_PORT=3306
      - MYSQL_SERVICE_USER=root
      - MYSQL_SERVICE_PASSWORD=root
      - MYSQL_SERVICE_DB_PARAM=characterEncoding=utf8&connectTimeout=1000&socketTimeout=3000&autoReconnect=true&useUnicode=true&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
      - NACOS_AUTH_IDENTITY_KEY=2222
      - NACOS_AUTH_IDENTITY_VALUE=2xxx
      - NACOS_AUTH_TOKEN=VGhpc0lzTXlDdXN0b21TZWNyZXRLZXkwMTIzNDU2Nzg=
    ports:
      - "8080:8080"
      - "8848:8848"
      - "9848:9848"
    volumes:
      - ../data/mydata/nacos/logs:/home/nacos/logs
      - ../data/mydata/nacos/data:/home/nacos/data
    depends_on:
      - mysql01
    restart: always

  # RustFS 服务（假设的 Rust 文件系统服务）
  rustfs:
    # 镜像名称 - 请根据实际的 RustFS 镜像替换
    image: rustfs/rustfs:latest  # 或具体版本号
    container_name: rustfs
    # 端口映射 - 根据 RustFS 服务的实际端口调整
    ports:
      - "8081:8081"  # 调整为 RustFS 实际使用的端口
      - "9001:9001"  # http://127.0.0.1:9001/rustfs/console/auth/login
    # 数据卷挂载 - 根据需要映射数据目录
    volumes:
      - ../data/mydata/rustfs/data:/app/data  # 根据实际目录结构调整
      - ../data/mydata/rustfs/config:/app/config
    # 环境变量 - 根据 RustFS 需要的配置添加
    environment:
      - RUST_LOG=info
      - SERVER_PORT=8081
    # 依赖关系 - 如果 RustFS 依赖其他服务
    depends_on:
      - mysql01  # 如果需要数据库连接
    restart: always